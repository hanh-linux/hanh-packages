#!/bin/sh
eval "$*"

if test -z "$kver"; then
       	kver="$(uname -r)"
fi

if test -z "$sysroot"; then
       	sysroot=/
fi

if test -n "$bin"; then
	bin="$(echo $bin | sed 's/,/ /g')"
fi

if test -n "$lib"; then
	lib="$(echo $lib | sed 's/,/ /g')"
fi

if test -n "$hooks"; then
       	hooks="$(echo $hooks | sed 's/,/ /g')"
fi

if test -n "$drivers"; then
	drivers="$(echo $drivers | sed 's/,/ /g')"
fi

work="$(pwd)/workdir"

mkdir -p $work
cd $work 

echo "(1/4) Working on essential files..."
cp -r $sysroot/usr/share/gen-initramfs/busybox-initramfs/* .
mkdir -p new_root hooks hooks-before hooks-after \
	etc usr/lib usr/bin var tmp run sys proc \
	dev lib64 mnt opt root var
ln -sf usr/bin bin 
ln -sf usr/bin sbin
ln -sf 

mknod -m 640 dev/console c 5 1
mknod -m 664 dev/null    c 1 3

cp -r $sysroot/usr/lib/libc.so $workdir/usr/lib/libc.so
cp -r $sysroot/usr/lib/ld-musl-x86_64.so.1 $workdir/usr/lib/ld-musl-x86_64.so.1
cp -r $sysroot/usr/lib/libunwind* $workdir/usr/lib/
cp -r $sysroot/usr/lib/libkmod.so* $workdir/usr/lib/

for x in $bin; do
	cp -r $sysroot/$x $workdir/usr/bin
done

for x in $lib; do
 cp $sysroot/$x $work/$x
done

for x in $hooks; do 
	for y in "before" "" "after"; do 
		if test -n "$y"; then
			filetype=".$y"
			stage="-$y"
		fi

		if test -f "$sysroot/$prefix/share/gen-initramfs/hooks/${x}${y}"; then
		       	install -Dm755 $sysroot/$prefix/share/gen-initramfs/hooks/"${x}${y}" ./hooks$stage/$x
		fi
	done
	
	if test -f $sysroot/$prefix/share/gen-initramfs/hooks/$x.sh; then
		. $sysroot/$prefix/share/gen-initramfs/hooks/$x.sh
	fi
done

echo "(2/4) Copying modules..."

liblink=$(readlink $sysroot/lib) 

if test -z "$liblink"; then 
	liblink=/lib
fi

for modgrp in crypto fs lib; do
	cp -r $sysroot/$liblink/modules/$kver/kernel/$modgrp $work/usr/lib/modules/$kver/kernel/$modgrp
done

for modgrp in hid block ata md firewire scsi message pcmcia virtio usb/host usb/storage; do
	cp -r $sysroot/$liblink/lib/modules/$kver/kernel/drivers/$modgrp $work/usr/lib/modules/$kver/kernel/drivers/$modgrp
done

for mod in $modules; do
	cp -r $sysroot/$liblink/modules/$kver/kernel/$mod $work/usr/lib/modules/$kver/kernel/$mod
done
         
cp -r $sysroot/$liblink/modules/$kver/modules.* lib/modules/$kver/

echo "(3/4) Copying init file..."
install -Dm755 $sysroot/$prefix/share/gen-initramfs/init.in ./init

echo "(4/4) Generating initramfs..."
find . | cpio -o -H newc | gzip -9 > initramfs-$kver.img
